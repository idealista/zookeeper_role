---
dist: bionic
language: python
python: "3.9"
os: linux
services:
  - docker
install:
  - pip install pipenv
  - pipenv sync

env:
  global:
    - secure: SyuJqEsbDQNy4IxT3wGc6wOo+MBaL5AErCVCN2b4Zybp/+eh7YBnvBjFV1yBux7S31S2jdBbC2nAA3L+mrdjAa3TcPULNvUX5oIRtJxfHoTK4CbkeicWfZUd+rb8S1G4Bu6bTvFSneNxrf4fKzNiwbVtq5LLHZ0xgCbrlzn+VUsdnt5jNkLj4kID2Hvjg48INNNtNN3/dvVbEG7WUisa2Jkdd2MGOBdxBI9U/CGxPNSyKFC0ZyDoe4QBq5vCeSObSBooXFpUVae5Umf0zUM/Rxwi6ICUGw7RvSOpwki68pF6trEZIegpObehfyw8LGdqpaRvY3D7FAgLnf/fZfsp5ftBkICzn6Z2pu8X+vgMQthYmHxYfAdfmvvML790s2zFvEuEuZ92b4CMy5t7ThKrDQzszrGr9su3evYmF5Rg0IKHf99+8iRYc77G/YaRtw3pk6xOpyysADS33AVp0/uTqrR4SXSsUswYV9u6JKLnvA1mMVb9OrPpJhX53st7lmpg3mrCfebLEFDr4b3BGkK12ujFYlTkKSOkdKtkOurv7ePIN13j2oGl6JOwG1dA20PhE96kOtw5G88yYkJHLyfmVkIJ43V98g8K3bGtq5VBtTVkgWSmnQeswP8trusT1lk6NhvLDHu7VDKf13TCA5vnObol5fib1ZySsRXTfj4yxzA=
    - secure: X4H1gMdHapqJLhTaLq5siAdnYph5zEbUJZN/yGEQTAuIW7GTZF2gG1nH5OxkedZLdhjhgvBxYh/fv6QCpmd3wy/GM5rGdEntLF787354CCkUAWrDymyC46S5X1EoeuNbFZiX0OAoF7UBhOTP91OMb9rTP/pP3ZYOUYFJYCTtuq7xSlcUqBOR5pXRcRT3Z4P7yFNQPTtyIcmHxvKplbrp6FJi9eAGuvHW5rbJ+gphuhBu1yHrb4QMJvnSXFcyMfPxMIogyKIizLyAjn2CeHbfQOihZp4x/VMNeiLiuLBKfNpr2kOl5DkF2f+JEXGvztjOhAzB7e0PPHmSGoPOWxU2W15b18vXhGJgTTGB5AbnyzImTdw1Oa6omsEU7MzajReNWkw7KzcXKbqBscxXOQK1Q264glGL+AhI6N+CySbZ/XDUfprM+fqn9JrQx4OpgtIUpqAyEI3N3ko1UuJ7Yb7Qzl4XEFioUUgKzpJhtNtUyLuheHUi+8taunxYq1KtNJDzDRoo9X58OcOiULp+LW1zOWF2BbWFBOj+f2eN+WXLxIS49UxW5qcJoEh/BXDF0j/Nppw7AgzXe+LUQ4wvjT61igT1gpA5HjjIQ4VNHQkOw+fesHMNuh62UDlZoUGhRgNaunvfkp2/3ACocHfLxV+O/oqxLAYMVWqGZBv1qs9udSY=
  matrix:
    - MOLECULE_DISTRO=idealista/jdk:8u302-stretch-openjdk-headless ZOOKEEPER_VERSION=3.4.14
    - MOLECULE_DISTRO=idealista/jdk:8u292-buster-adoptopenjdk-headless ZOOKEEPER_VERSION=3.4.14
    - MOLECULE_DISTRO=idealista/jdk:8u302-stretch-openjdk-headless ZOOKEEPER_VERSION=3.5.6
    - MOLECULE_DISTRO=idealista/jdk:8u292-buster-adoptopenjdk-headless ZOOKEEPER_VERSION=3.5.6
    - MOLECULE_DISTRO=idealista/jdk:8u302-stretch-openjdk-headless ZOOKEEPER_VERSION=3.7.0
    - MOLECULE_DISTRO=idealista/jdk:8u292-buster-adoptopenjdk-headless ZOOKEEPER_VERSION=3.7.0
script:
  - pipenv run molecule test

notifications:
  webhooks:
    - https://galaxy.ansible.com/api/v1/notifications/
  email:
    if: branch = main
    on_success: change
    on_failure: always
    recipients:
      - desarrollo.benders@idealista.com

deploy:
  provider: script
  script: ANSIBLE_ROLES_PATH=../ pipenv run ansible-playbook dockerhub/deploy.yml --extra-vars "docker_hub_email=${DOCKER_EMAIL} docker_hub_username=${DOCKER_USERNAME} docker_hub_password=${DOCKER_PASSWORD}"
  on:
    branch: master
    tags: true
