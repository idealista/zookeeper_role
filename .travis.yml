---
dist: bionic
language: python
python: "3.9"
os: linux
services:
  - docker
install:
  - pip install pipenv
  - pipenv sync
script:
  - pipenv run molecule test --all


env:
  matrix:
    - MOLECULE_DISTRO=idealista/jdk:8u322-stretch-openjdk-headless ZOOKEEPER_VERSION=3.4.14
    - MOLECULE_DISTRO=idealista/jdk:8u292-buster-adoptopenjdk-headless ZOOKEEPER_VERSION=3.4.14
    - MOLECULE_DISTRO=idealista/jdk:8u322-stretch-openjdk-headless ZOOKEEPER_VERSION=3.5.6
    - MOLECULE_DISTRO=idealista/jdk:8u292-buster-adoptopenjdk-headless ZOOKEEPER_VERSION=3.5.6
    - MOLECULE_DISTRO=idealista/jdk:8u322-stretch-openjdk-headless ZOOKEEPER_VERSION=3.8.0
    - MOLECULE_DISTRO=idealista/jdk:8u292-buster-adoptopenjdk-headless ZOOKEEPER_VERSION=3.8.0

notifications:
  webhooks:
    - https://galaxy.ansible.com/api/v1/notifications/
  email:
    if: branch = main
    on_success: change
    on_failure: always
    recipients:
      - desarrollo.benders@idealista.com

deploy:
  provider: script
  script: ANSIBLE_ROLES_PATH=../ pipenv run ansible-playbook dockerhub/deploy.yml --extra-vars "docker_hub_email=${DOCKER_EMAIL} docker_hub_username=${DOCKER_USERNAME} docker_hub_password=${DOCKER_PASSWORD}"
  on:
    branch: master
    tags: true
